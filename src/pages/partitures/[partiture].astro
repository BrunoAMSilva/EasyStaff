---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Button from "../../components/base/Button.astro";
import Sheet from "../../components/partiture/Partiture.astro";
import SvgSheet from "../../components/partiture/svg/SvgPartiture.astro";
import NotationMenu from "../../components/base/NotationMenu.astro";
import { extractTempo } from "../../utils/tempo";

export async function getStaticPaths() {
    const partitures = await getCollection("partitures");
    return partitures.map((partiture) => ({
        params: { partiture: partiture.id },
        props: { partiture },
    }));
}

const { partiture } = Astro.props;

const title = partiture.data.work?.workTitle;
const firstMeasure = partiture.data.parts[0]?.measures[0];
if (!firstMeasure) {
    throw new Error("Partiture has no measures");
}
const tempo =
    extractTempo(partiture.data.parts[0]?.measures[0]?.directions) || 120;
const measures = partiture.data.parts[0]?.measures.length ?? 0;
const timeSignature =
    partiture.data.parts[0]?.measures[0]?.attributes?.time?.beats;
const staffsCount = firstMeasure.attributes?.staves ?? 1;
---

<BaseLayout>
    <header
        class="mx-auto max-w-4xl flex justify-between items-center mb-8 px-4"
    >
        <hgroup>
            <h1 class="text-2xl font-bold">{title}</h1>
            <p class="mb-2">Tempo: <strong>{tempo}</strong></p>
        </hgroup>
        <div class="flex items-center gap-2">
            <NotationMenu />
            <Button id="btnPlay" class="outlined"> ▶ </Button>
        </div>
    </header>
    
    <!-- Display Options -->
    <div class="mx-auto max-w-4xl flex flex-wrap gap-4 mb-6 px-4">
        <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="toggleRenderer" checked class="form-checkbox" />
            <span>Use SVG Renderer</span>
        </label>
        <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="showBeatMarkers" checked class="form-checkbox" />
            <span>Show Beat Markers</span>
        </label>
        <label class="flex items-center gap-2 text-sm">
            <select id="notationType" class="form-select text-sm">
                <option value="letter">Letter Notation (C, D, E...)</option>
                <option value="solfege">Solfège Notation (Do, Re, Mi...)</option>
            </select>
        </label>
        <label class="flex items-center gap-2 text-sm">
            <select id="noteRenderMode" class="form-select text-sm">
                <option value="bar">Bar Mode</option>
                <option value="symbol">Symbol Mode</option>
            </select>
        </label>
    </div>

    <p
        class="starting fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-6xl z-20 font-bold text-gray-400 opacity-0 pointer-events-none transition-opacity duration-500 ease-in-out starting:opacity-100"
    >
        Starting...
    </p>
    
    <!-- SVG Renderer (default) -->
    <div id="svgRenderer">
        <SvgSheet partiture={partiture.data} />
    </div>
    
    <!-- Original Grid Renderer -->
    <div id="gridRenderer" style="display: none;">
        <Sheet partiture={partiture.data} />
    </div>
</BaseLayout>

<script
    define:vars={{
        tempo,
        measures,
    }}
>
    const btnPlay = document.getElementById("btnPlay");
    const toggleRenderer = document.getElementById("toggleRenderer");
    const svgRenderer = document.getElementById("svgRenderer");
    const gridRenderer = document.getElementById("gridRenderer");
    let isPlaying = false;

    btnPlay?.addEventListener("click", () => {
        isPlaying = !isPlaying;
        document.body.classList.toggle("playing");
        btnPlay.textContent = isPlaying ? "❚❚" : "▶";
        // notify other components (decoupled) that play state changed
        document.body.classList.toggle("starting", isPlaying);
        setTimeout(() => {
            document.dispatchEvent(
                new CustomEvent("piano:play-toggle", { detail: isPlaying }),
            );
            document.body.classList.remove("starting");
        }, 3000);
    });

    document.addEventListener("piano:play-toggle", (event) => {
        const isPlaying = event.detail;
        btnPlay.textContent = isPlaying ? "❚❚" : "▶";
    });

    // Toggle between SVG and Grid renderer
    toggleRenderer?.addEventListener("change", (e) => {
        const useSvg = e.target.checked;
        if (svgRenderer && gridRenderer) {
            svgRenderer.style.display = useSvg ? "block" : "none";
            gridRenderer.style.display = useSvg ? "none" : "block";
        }
    });

    // Note: Other options (beat markers, notation type, render mode) would require
    // re-rendering the component with new props, which is beyond client-side JS
    // For now, they are shown as examples of the API
</script>
<style is:global>
    body.starting .starting {
        opacity: 1;
    }
</style>