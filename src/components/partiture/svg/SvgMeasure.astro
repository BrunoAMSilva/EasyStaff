---
import type { Measure, Note } from "../../../content.config";
import SvgNote from "./SvgNote.astro";

interface Props {
    measure: Measure;
    measureIndex: number;
    x: number;
    topY: number;
    measureWidth: number;
    staffHeight: number;
    staffLineSpacing: number;
    staffVerticalSpacing: number;
    staves: number;
    totalMeasures: number;
    notationType: "letter" | "solfege";
    noteRenderMode: "bar" | "symbol";
    showBeatMarkers: boolean;
}

const {
    measure,
    measureIndex,
    x,
    topY,
    measureWidth,
    staffHeight,
    staffLineSpacing,
    staffVerticalSpacing,
    staves,
    totalMeasures,
    notationType,
    noteRenderMode,
    showBeatMarkers,
} = Astro.props;

const beats = measure.attributes?.time.beats || 4;
const measureNumber = measure.number ? parseInt(measure.number) : 1;
const beatWidth = measureWidth / beats;

// Calculate absolute beat positions for this measure
const totalBeatsBefore = (measureNumber - 1) * beats + 1;

// Map notes to their positions
const currentBeats = new Map<number, number>(
    new Array(staves).fill(0).map((_, idx) => [idx + 1, 0])
);
const lastNotes = new Map<number, Note>();

interface MappedNote {
    note: Note;
    beat: number;
    staffRelativeBeat: number;
}

const mappedNotes: MappedNote[] = measure.notes.map((note) => {
    const staff = note.staff || 1;
    const beat = currentBeats.get(staff) || 0;

    const lastNote = lastNotes.get(staff);
    lastNotes.set(staff, note);

    if (!lastNote || note.isChord) {
        const staffBeat = beat === 0 ? 1 : beat;
        currentBeats.set(staff, staffBeat);
        return {
            note,
            beat: staffBeat + totalBeatsBefore,
            staffRelativeBeat: staffBeat - 1, // Convert to 0-indexed for positioning
        };
    }

    const currentBeat = beat === 0 ? 1 : beat + (lastNote.duration || 1);
    currentBeats.set(staff, currentBeat);

    return {
        note,
        beat: currentBeat + totalBeatsBefore,
        staffRelativeBeat: currentBeat - 1, // Convert to 0-indexed for positioning
    };
});

// Measure bar height spans all staves
const measureBarHeight = staves * (staffHeight + staffVerticalSpacing) - staffVerticalSpacing;
---

<g class="svg-measure" data-measure-number={measureNumber}>
    <!-- Measure bar line -->
    <line
        x1={x + measureWidth}
        y1={topY}
        x2={x + measureWidth}
        y2={topY + measureBarHeight}
        stroke="currentColor"
        stroke-width="2"
        class="measure-bar"
    />

    <!-- Beat markers within measure (optional) -->
    {
        showBeatMarkers &&
            Array.from({ length: beats }).map((_, beatIdx) => {
                const beatX = x + beatIdx * beatWidth;
                return (
                    <g
                        class="beat beat-marker"
                        data-beat={totalBeatsBefore + beatIdx}
                    >
                        <line
                            x1={beatX}
                            y1={topY}
                            x2={beatX}
                            y2={topY + measureBarHeight}
                            stroke="rgba(156, 163, 175, 0.2)"
                            stroke-width="1"
                            stroke-dasharray="4,4"
                        />
                        <text
                            x={beatX + beatWidth / 2}
                            y={topY - 5}
                            text-anchor="middle"
                            font-size="10"
                            fill="currentColor"
                            class="beat-number"
                        >
                            {(beatIdx % beats) + 1}
                        </text>
                    </g>
                );
            })
    }

    <!-- Render all notes in this measure -->
    {
        mappedNotes.map((mappedNote) => {
            const staff = mappedNote.note.staff || 1;
            const staffY = topY + (staff - 1) * (staffHeight + staffVerticalSpacing);
            const noteX = x + mappedNote.staffRelativeBeat * beatWidth;
            const noteWidth = (mappedNote.note.duration || 1) * beatWidth;

            return (
                <SvgNote
                    note={mappedNote.note}
                    measure={measure}
                    beat={mappedNote.beat}
                    x={noteX}
                    y={staffY}
                    width={noteWidth}
                    staffHeight={staffHeight}
                    staffLineSpacing={staffLineSpacing}
                    clef={staff === 1 ? "treble" : "bass"}
                    notationType={notationType}
                    renderMode={noteRenderMode}
                />
            );
        })
    }
</g>

<style>
    .measure-bar {
        color: rgb(156, 163, 175);
    }

    :global(.dark) .measure-bar {
        color: rgb(156, 163, 175);
    }

    .beat-number {
        color: rgb(107, 114, 128);
        opacity: 0.6;
    }

    :global(.dark) .beat-number {
        color: rgb(209, 213, 219);
    }
</style>
