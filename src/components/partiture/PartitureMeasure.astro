---
import type { HTMLAttributes } from "astro/types";
import type { Measure, Note } from "../../content.config";
import PartitureNote from "./PartitureNote.astro";

interface Props extends HTMLAttributes<"div"> {
  measure: Measure;
  offsetStart: number;
  measureIndex?: number;
}
const { measure, offsetStart, measureIndex = 0 } = Astro.props as Props;

// Get tie info from global (set by PartiturePart)
const tieInfoMap = (globalThis as any).__tieInfoMap || new Map();

const staves = measure.attributes?.staves || 1;
const beats = measure.attributes?.time.beats || 4;
const measureNumber = measure.number ? parseInt(measure.number) : 1;
const totalBeatsBefore =
  (measureNumber - 1) * (beats ? beats : 4) + offsetStart;
const currentBeats = new Map<number, number>(
  new Array(staves).fill(0).map((_, idx) => [idx + 1, 0]),
);
const lastNotes = new Map<number, Note>();
const mappedNotes = measure.notes.map((note, noteIndex) => {
  const staff = note.staff || 1;
  const beat = currentBeats.get(staff) || 0;

  const lastNote = lastNotes.get(staff);
  lastNotes.set(staff, note);
  
  // Get tie info for this note
  const tieKey = `${measureIndex}-${noteIndex}`;
  const tieInfo = tieInfoMap.get(tieKey);
  
  if (!lastNote || note.isChord) {
    currentBeats.set(staff, beat === 0 ? 1 : beat);
    return {
      note,
      beat: (beat === 0 ? 1 : beat) + totalBeatsBefore,
      tieInfo
    };
  }

  const currentBeat = beat === 0 ? 1 : beat + (lastNote.duration || 1);
  currentBeats.set(staff, currentBeat);

  return {
    note,
    beat: currentBeat + totalBeatsBefore,
    tieInfo
  };
});
---

<hr
  style={`grid-column: ${measureNumber * 4 + 1}; height: calc(100% - 1.5rem);`}
  class="w-0 row-start-3 ml-auto measure-border -row-end-3 border-r-2 self-center border-gray-400 dark:border-gray-400 relative -right-[0.07em]"
/>
{
  mappedNotes.map((noteData) => {
    return (
      <PartitureNote 
        note={noteData.note} 
        measure={measure} 
        beat={noteData.beat}
        tieInfo={noteData.tieInfo}
      />
    );
  })
}
