---
import type { HTMLAttributes } from "astro/types";
import type { Measure, Note } from "../../content.config";
import { getNoteColorByStep } from "../../utils/note-colors";
import { getNoteName } from "../../utils/note-notation";
import { getNoteLinePosition } from "../../utils/note-position";
import { requiresSupportingLine } from "../../utils/note-position";

interface TieInfo {
    isStart: boolean;
    isMiddle: boolean;
    isEnd: boolean;
    totalDuration: number;
}

interface Props extends HTMLAttributes<'div'> {
    note: Note;
    measure: Measure;
    beat: number;
    tieInfo?: TieInfo;
}

const { note, measure, beat, tieInfo, class: classList = "" } = Astro.props;

// Hide notes that are tie continuations (middle or end of tie)
const shouldHide = tieInfo && (tieInfo.isMiddle || tieInfo.isEnd);

const color = getNoteColorByStep(note.pitch?.step || "");

const stave = note.staff || 1;
// Use extended duration for tie start notes
const duration = tieInfo?.isStart && tieInfo.totalDuration > 0 
    ? tieInfo.totalDuration 
    : (note.duration || 1);
const fingering = note.notations?.technical?.fingering || null;
const pitch = note.pitch;
let row = 0;
let letterNote = "";
let solfegeNote = "";
let octave = 0;
let needsSupportingLine = false;
if (pitch) {
    octave = pitch.octave ?? 4;
    const step = pitch.step;
    row = getNoteLinePosition(
        step,
        octave || 4,
        stave === 1 ? "treble" : "bass",
    );
    letterNote = step ? getNoteName(step, "letter") : "";
    solfegeNote = step ? getNoteName(step, "solfege") : "";
    needsSupportingLine = requiresSupportingLine(
        step,
        octave,
        stave === 1 ? "treble" : "bass",
    );
}
if (note.rest) {
    row = stave === 1 ? 7 : 20; // Position for rest symbols
}
---

{!shouldHide && !note.rest && (<div
    style={`grid-row: ${row}; grid-column: ${beat} / span ${duration};`}
    class={`note-visual relative flex items-center justify-between mx-2 pl-2 rounded-lg text-white/80 text-md font-semibold ${color} ${classList}`}
>
    <span class="note-labels flex flex-col gap-0.5">
        <span class="notation-label notation-letter uppercase"
            >{letterNote}{octave}</span
        >
        <span class="notation-label notation-solfege uppercase"
            >{solfegeNote} {octave}</span
        >
    </span>
        {needsSupportingLine && (
            <div class="absolute top-1/2 bottom-1/2 -left-2 -right-2 border -z-10"></div>
        )}
    {
        fingering && (
            <span class="rounded-r-lg bg-black/20 font-light text-xs h-full aspect-square text-center grid place-content-center">
                {fingering}
            </span>
        )
    }
</div>)}
{!shouldHide && note.rest && (
    <div style={`grid-row: ${row}; grid-column: ${beat} / span ${duration}`}
    class="border border-dashed mx-2 pl-2 rounded-lg"
    >&nbsp;</div>
)}

<style>
    .note-visual {
        background-image: linear-gradient(
            to right,
            transparent,
            rgb(255 255 255 / 0.4)
        );
        background-blend-mode: overlay;
    }

    .note-visual.complete {
        opacity: 0.5;
        filter: saturate(0.2);
        transition: opacity 0.5s ease, filter 0.5s ease;
    }
</style>